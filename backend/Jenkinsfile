pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                dir('backend') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }
        stage('Start SQL') {
            steps {
                sh 'docker start nexum-db'
            }
        }
        stage('Transfer Jar to Deploy Folder') {
            environment {
                APP_JAVA = 'backend-0.0.1-SNAPSHOT.jar'
                APP_PATH = '/home/ubuntu/deploy/'
            }
            steps {
                dir('backend') {
                    sh "docker stop nexum-back || true"
                    sh "rm $APP_PATH$APP_JAVA || true"
                    sh "cp target/$APP_JAVA $APP_PATH"
                    sh "chmod +x $APP_PATH$APP_JAVA"
                    sh "docker rm nexum-back || true"
                }
            }
        }
        stage('Deploy') {
            steps {
                script {
                    if (isDockerInstalled()) {
                        sh "docker run -d -p 8000:8000 --network nexum-network --name nexum-back -v $APP_PATH$APP_JAVA:/app/$APP_JAVA nexum-image-back"
                    } else {
                        echo 'Docker is not installed. Skipping deployment.'
                    }
                }
            }
        }
    }
}

def isDockerInstalled() {
    try {
        sh 'docker --version'
        return true
    } catch (Exception e) {
        return false
    }
}
